# Система миграций базы данных

Модуль `migrations` предоставляет инструменты для управления версиями схемы базы данных с использованием Alembic.

## Обзор

Система миграций позволяет:

- Управлять изменениями схемы БД
- Отслеживать историю изменений
- Применять и откатывать миграции
- Работать с различными окружениями

## Структура

```
migrations/
├── env.py          # Основной файл конфигурации
├── script.py.mako  # Шаблон для генерации миграций
└── versions/       # Файлы миграций
```

## Основные компоненты

### env.py

Главный конфигурационный файл миграций. Содержит логику подключения к БД и настройки выполнения миграций.

::: src.infrastructure.database.migrations.env
    :docstring:
    :members:

### script.py.mako

Шаблон для генерации новых миграций. Определяет структуру и содержимое файлов миграций.

## Работа с миграциями

### Создание новой миграции

```bash
alembic revision -m "Описание изменений"
```

### Применение миграций

```bash
# Применить все неподтверждённые миграции
alembic upgrade head

# Откат на одну миграцию
alembic downgrade -1

# Применить конкретную миграцию
alembic upgrade <revision>
```

### Проверка состояния

```bash
# Показать текущую ревизию
alembic current

# Показать историю миграций
alembic history

# Показать незавершённые миграции
alembic heads
```

## Особенности реализации

1. **Асинхронная загрузка настроек**
   - Загрузка секретов из Vault
   - Асинхронное получение URI подключения

2. **Поддержка оффлайн-режима**
   - Возможность работы без подключения к БД
   - Генерация SQL-скриптов

3. **Безопасность**
   - Чтение учётных данных из защищённого хранилища
   - Отсутствие хардкода чувствительных данных

## Пример миграции

```python
"""create_user_table

Revision ID: 123456789abc
Revises: 
Create Date: 2023-01-01 12:00:00.000000

"""
from alembic import op
import sqlalchemy as sa


def upgrade():
    op.create_table(
        'users',
        sa.Column('id', sa.UUID(), nullable=False),
        sa.Column('email', sa.String(), nullable=False),
        sa.Column('hashed_password', sa.String(), nullable=False),
        sa.PrimaryKeyConstraint('id')
    )


def downgrade():
    op.drop_table('users')
```

## Рекомендации

1. **Именование миграций**
   - Используйте понятные описательные имена
   - Указывайте номер задачи из трекера (если есть)

2. **Работа в команде**
   - Синхронизируйте миграции через систему контроля версий
   - Решайте конфликты немедленно

3. **Безопасность**
   - Не храните чувствительные данные в миграциях
   - Используйте переменные окружения для конфиденциальной информации

## Отладка

Для отладки миграций можно использовать:

```bash
# Вывод SQL без выполнения
alembic upgrade --sql

# Подробное логирование
alembic -x debug=true upgrade head
```

## Связанные компоненты

- [Движок БД](../engine.md)
- [ORM-модели](../../../../../adapters/orm.md)
- [Настройки приложения](../../../../config/loader.md)
